#pragma once
/* Includes ------------------------------------------------------------------*/
#include "chassis_controller_utils.h"
/* Macros --------------------------------------------------------------------*/
#define BALANCE_CONTROL_TICK 2u // 控制周期，单位毫秒
#define LQR_PI 3.14159265358979323846f // 圆周率π
#define GRAVITY_ACC 9.8f // 重力加速度，单位m/s²
#define TIME_INTERVAL 0.002f // 时间间隔，单位秒

/* PID控制器参数 */
#define PID_MEAN_L0_KP 40.0f // 腿长均值PID控制器比例系数
#define PID_MEAN_L0_KI 0.02f // 腿长均值PID控制器积分系数
#define PID_MEAN_L0_KD 2.0f // 腿长均值PID控制器微分系数

#define PID_DIFF_L0_KP 40.0f // 腿长差值PID控制器比例系数
#define PID_DIFF_L0_KI 0.001f // 腿长差值PID控制器积分系数
#define PID_DIFF_L0_KD 0.2f // 腿长差值PID控制器微分系数

/* PID积分限幅 */
#define PID_MEAN_L0_MAX_I 0.2f // 腿长均值PID积分项最大值
#define PID_DIFF_L0_MAX_I 0.05f // 腿长差值PID积分项最大值

/* PID输出限幅 */
#define PID_MEAN_L0_MAX 2.0f // 腿长均值PID输出最大值

#define PID_DIFF_L0_MAX 1.0f // 腿长差值PID输出最大值

/* 腿长相关参数 */
#define L0_STABLE 0.18f     // 腿长初始稳定值，单位米
#define L0_MID 0.24f        // 腿长中间值，单位米
#define L0_MIN 0.14f        // 最小允许腿长，单位米
#define L0_MAX 0.37f        // 最大允许腿长，单位米
#define L0_SQUAT 0.2f       // 转弯时下蹲高度，单位米
// #define L0_JUMP_FOLDING 0.12f      // 跳跃时收腿高度,0.12可以收腿到最短
#define L0_JUMP_FOLDING 0.2f      // 跳跃时收腿高度,0.2电池不容易关机

#define F_LOWPASS_ALPHA 0.05f // 跳跃时支持力变化率低通滤波系数

/* 底盘零点修正参数 */
#define CHASSIS_PITCH_OFFSET 0.0f // 底盘俯仰角偏移量
#define CHASSIS_ROLL_OFFSET 0.0f  // 底盘横滚角偏移量

/* 电机角度偏移参数 */
#define MOTOR_ANG_OFFSET 0.0f/180.0f*LQR_PI // 电机角度偏移量，转换为弧度

/* 同侧关节电机角度差范围 */
#define THETA2_MINUS_THETA1_MIN 1.4f // 同侧关节电机角度差最小值，弧度
#define THETA2_MINUS_THETA1_MAX 3.4f // 同侧关节电机角度差最大值，弧度

/* 虚拟腿等效倾角平衡位置 */
#define THETA_STABLE_LOW -0.0f // 虚拟腿等效倾角平衡位置下限
#define THETA_STABLE_HIGH -0.0f // 虚拟腿等效倾角平衡位置上限


/* 速度限幅参数 */
#define VEL_X_UPPER 3.3f // X轴速度上限(高)，单位m/s
#define VEL_X_MID 2.5f   // X轴速度中值，单位m/s
#define VEL_X_LOWER 2.0f // X轴速度下限(低)，单位m/s

/* 位控起身模式切换阈值 */
#define LIFTUP_2_STAND_THRESHOLD 0.2f                // 离地模式切换到站立模式的阈值
#define LIFTUP_2_SELFSAVE_GRAVITY_THRESHOLD 0.0f     // 离地模式切换到自保护模式的重力阈值
#define LIFTUP_2_SELFSAVE_ANGVEL_THRESHOLD 0.3f      // 离地模式切换到自保护模式的角速度阈值
#define SELFSAVE_2_LIFTUP_THRESHOLD -4.9f            // 自保护模式切换到离地模式的阈值

/* 离地检测循环队列长度 */
#define OFF_GROUND_DETECT_LIST_LENGTH 20 // 离地检测使用的数据缓存队列长度

/* 惯性传感器数据处理限幅参数 */
#define INERTIAL_ACC_LIMIT_RATIO 0.5f                    // 惯性加速度限幅比例
#define INERTIAL_ACC_HEIGHT_LIMIT_THRESHOLD 2.0f         // 惯性加速度高度限幅阈值
#define INERTIAL_ACC_ROLL_COMPENSATE_LOWER 2.0f          // 惯性加速度横滚补偿下限
#define INERTIAL_ACC_ROLL_COMPENSATE_UPPER 4.0f          // 惯性加速度横滚补偿上限
#define INERTIAL_ACC_ROLL_COMPENSATE_LIMIT 0.0f          // 惯性加速度横滚补偿限幅

#define MAX_DISPLACEMENT_X 0.3f // X轴最大位移

#define FRICTION_COEF 0.5f // 摩擦系数

/* 速度观测卡尔曼滤波相关参数 */
#define MAX_IMU_ACC 4.2f              // IMU最大加速度
#define HIGH_YAW_SPEED_THRESHOLD 10.0f // 高偏航速度阈值
#define RELIABLE_OBS_VAR 0.01f        // 可靠观测方差
#define NORMAL_OBS_VAR 0.1f           // 正常观测方差
#define UNRELIABLE_OBS_VAR 100.0f     // 不可靠观测方差
#define MAX_MOTOR_SPEED 4.5f          // 电机最大速度
#define SLIPPAGE_THRESOLD_LOW 0.2f    // 打滑检测低阈值
#define SLIPPAGE_THRESOLD_HIGH 1.0f   // 打滑检测高阈值

/* 离地检测参数 */
#define OFF_GROUND_FORCE_THRESHOLD 10.0f // 离地检测力阈值

/* 电机力矩常数与减速比参数 */
#define CKYF_TORQUE_CONSTANT 2.4f * 0.5f   // CKYF电机力矩常数
#define M3508_TORQUE_CONSTANT 0.246f       // M3508电机力矩常数
#define GEARBOX_RATIO 268.0f/17.0f         // 减速箱减速比

/* 功率模型系数参数 */
#define POWER_MODEL_C1 0.09803223897567591f         // 功率模型系数1
#define POWER_MODEL_C2 0.23754971414678447f / 14.0f  // 功率模型系数2
#define POWER_MODEL_C3 0.001814064367158451f / 14.0f / 14.0f  // 功率模型系数3
#define POWER_MODEL_C4 0.10080805676392363f / 14.0f  // 功率模型系数4
#define POWER_MODEL_C5 1.2734987902858748f           // 功率模型系数5

/* 两侧支持力差值补偿参数 */
// delta_F = DELTA_F_A * mean_l0 + DELTA_F_B
#define DELTA_F_A 0.0f  // 支持力差值补偿系数A
#define DELTA_F_B 0.0f  // 支持力差值补偿系数B

// 这里的转速是没有经过减速的.

/* 机器人物理参数结构体初始化 */
const BotParam robot_param = {
    0.215f,  // l1: 机器人结构参数l1，单位米
    0.215f,  // l2: 机器人结构参数l2，单位米
    0.258f,  // l3: 机器人结构参数l3，单位米
    0.258f,  // l4: 机器人结构参数l4，单位米
    0.0f,    // l5: 机器人结构参数l5，单位米
    0.098f,  // AF: 机器人结构距离AF，单位米
    0.098f,  // AH: 机器人结构距离AH，单位米
    0.118f,  // FG: 机器人结构距离FG，单位米
    0.118f,  // HG: 机器人结构距离HG，单位米
    0.117f,  // FB: 机器人结构距离FB，单位米
    0.066f,  // FJ: 机器人结构距离FJ，单位米
    0.117f,  // JK: 机器人结构距离JK，单位米
    0.066f,  // BK: 机器人结构距离BK，单位米
    0.258f,  // BC: 机器人结构距离BC，单位米
    0.014f,  // AP: 机器人结构距离AP，单位米
    0.044f,  // PM: 机器人结构距离PM，单位米
    0.05f,   // BN: 机器人结构距离BN，单位米
    0.101f,  // com_AB_2A: AB部件质心相对于A点的位置，单位米
    0.041f,  // com_AH_2A: AH部件质心相对于A点的位置，单位米
    0.059f,  // com_HG_2H: HG部件质心相对于H点的位置，单位米
    0.092f,  // com_JFG_2J_parallel_JF: JFG部件质心相对于J点沿JF方向的位置，单位米
    0.0085f, // com_JFG_2J_vertical_JF: JFG部件质心相对于J点垂直于JF方向的位置，单位米
    0.0585f, // com_JK_2J: JK部件质心相对于J点的位置，单位米
    0.14f,   // com_KBC_2C: KBC部件质心相对于C点的位置，单位米
    2.932f,  // ang_JFG: JFG部件角度，单位弧度
    0.249f,  // m_AB: AB部件质量，单位千克
    0.077f,  // m_AH: AH部件质量，单位千克
    0.052f,  // m_HG: HG部件质量，单位千克
    0.074f,  // m_JFG: JFG部件质量，单位千克
    0.051f,  // m_JK: JK部件质量，单位千克
    0.248f,  // m_KBC: KBC部件质量，单位千克
    0.06f,   // R_wheel: 轮子半径，单位米
    0.56f,   // m_wheel: 轮子质量，单位千克
    1.45f,   // m_wheel_leg: 轮腿组件质量，单位千克
    20.5f,   // M: 机器人总质量，单位千克
    0.408f,  // Wid: 机器人宽度，单位米
    0.268f,  // guide_wheel_high_x: 高位导向轮X坐标，单位米
    -0.17f,  // guide_wheel_high_z: 高位导向轮Z坐标，单位米
    0.05f,   // guide_wheel_high_x: 低位导向轮X坐标，单位米
    -0.19f,  // guide_wheel_high_z: 低位导向轮Z坐标，单位米
    0.204f,  // imu_to_left_y: IMU到左侧的距离(Y轴)，单位米
    -0.204f, // imu_to_right_y: IMU到右侧的距离(Y轴)，单位米
    -0.095f, // imu_to_center_x: IMU到中心的距离(X轴)，单位米

    L0_STABLE,  // l0_stable: 稳定状态下的腿长，使用预定义常量L0_STABLE

    0.036f,  // sprint_l_offset: 冲刺时长度偏移量，单位米
    0.120f,  // spring_l1: 弹簧长度参数l1，单位米
    0.195f,  // spring_l2: 弹簧长度参数l2，单位米

    0.0f,  // spring_F1: 弹簧力F1，单位牛顿
    0.0f   // spring_F2: 弹簧力F2，单位牛顿

};


/* 前向运动学矩阵系数 */
const float Matrix_coefficients_forward[6][40] = 
{
// 第一行：前向运动学矩阵系数，用于机器人运动控制算法
-39.4291174622160, -47.0360335908178, 11.4531262791033, 0.362239915079497, 111.779362264038, 5.33684239750898, 21.4725741120201, 0.572575673366523, 99.1153128984173, 8.93384794389567, 276.653112969898, 335.080317286729, -89.0924746119805, -26.1688414563452, -147.053423785881, 2.82850918796438, 23.1502566023708, 3.09553527505388, 711.010053573785, 34.7836312866527, 9.24587232916144, 9.32473311891364, 15.5999416886743, 6.32858999246122, 30.2169985415498, 0.508102484249294, -21.6183470472379, -0.398001914666681, -55.5931492098804, -7.71591324358145, -78.7585159500295, -94.7938972468570, 29.9348128373941, -12.9253284223351, 42.2039143404202, 3.80085694702028, 30.7804617522493, -1.00203364507856, -198.047539164539, -1.43240585551513,
// 第二行：前向运动学矩阵系数，用于机器人运动控制算法
9.24587233442012, 9.32473311965341, -15.5999416887519, -6.32858999239206, -21.6183470355339, -0.398001914554017, 30.2169985404125, 0.508102484266627, -55.5931492053534, -7.71591324370789, -78.7585159452737, -94.7938972319032, -29.9348128268893, 12.9253284176851, 30.7804617737110, -1.00203356175015, 42.2039143344959, 3.80085694722452, -198.047539159808, -1.43240588298502, -39.4291174639325, -47.0360335903879, -11.4531262789035, -0.362239917272108, 21.4725741117506, 0.572575673350740, 111.779362264903, 5.33684239754091, 99.1153129022533, 8.93384794462733, 276.653112977983, 335.080317284970, 89.0924746130279, 26.1688414555765, 23.1502566005966, 3.09553527468357, -147.053423818925, 2.82850918420907, 711.010053564413, 34.7836312838682,
// 第三行：前向运动学矩阵系数，用于机器人运动控制算法
3.44055808987510, 12.1715693686981, 3.15227122100848, 5.06681041259780, 19.9617823430403, 0.423504622603129, -13.6080504924016, 0.0170999067845224, -56.0527338329430, -7.46457121178037, -213.595922656220, -343.207001946857, 46.2406098973216, 4.86452845611732, 120.453332699440, 3.96190759870337, -35.8886730521581, -5.49521335333575, 176.844665114137, 47.0217290850189, 3.44055808056274, 12.1715693711357, -3.15227122162986, -5.06681041259947, -13.6080504934731, 0.0170999063383750, 19.9617823491285, 0.423504622357302, -56.0527338368021, -7.46457121171928, -213.595922656207, -343.207001940126, -46.2406099001444, -4.86452846110104, -35.8886730602186, -5.49521335327833, 120.453332656255, 3.96190756681477, 176.844665106619, 47.0217290826415,
// 第四行：前向运动学矩阵系数，用于机器人运动控制算法
39.1948320674363, 41.7451423922957, -17.0110738102111, -4.34020447322994, -123.445749091477, -6.30790669773597, -5.27230884324791, -0.179084295520870, -12.1233759479024, -1.22077940679505, -77.5353032680800, -72.9304488987177, 59.7926519551759, 23.1272132474212, -151.150990557781, -16.3967065305392, -58.8612856094049, -2.04285299077793, -766.210592803761, -56.7991881433318, -15.3816100718276, -19.1283017796180, -11.3230288696070, -3.87145920287701, -20.8229764973105, -0.655412970114028, 15.8636347933309, 0.280429252841961, 65.5136574741038, 9.00589142758124, 145.089684930225, 205.062495980643, -16.3458900669555, 7.78014018177650, -52.1383840942116, -2.35714384669505, -52.9967983206698, 0.0707589138680956, 153.007270105101, -8.18670413152756,
// 第五行：前向运动学矩阵系数，用于机器人运动控制算法
-15.3816100766020, -19.1283017793885, 11.3230288697943, 3.87145920284400, 15.8636347891611, 0.280429252728228, -20.8229764970237, -0.655412970229379, 65.5136574709968, 9.00589142765729, 145.089684927929, 205.062495975101, 16.3458900625747, -7.78014017833120, -52.9967983414681, 0.0707588658771686, -52.1383840933010, -2.35714384677932, 153.007270100964, -8.18670411892139, 39.1948320705036, 41.7451423915040, 17.0110738102634, 4.34020447428252, -5.27230884285958, -0.179084295406245, -123.445749093346, -6.30790669769240, -12.1233759488200, -1.22077940716323, -77.5353032719925, -72.9304488995203, -59.7926519550113, -23.1272132458426, -58.8612856066034, -2.04285299061406, -151.150990531555, -16.3967065210833, -766.210592797415, -56.7991881414250,
// 第六行：前向运动学矩阵系数，用于机器人运动控制算法
0.819219596629294, 1.98431079440909, 5.15394507964642, 0.961333125470248, -7.08202530478370, -0.389772668102829, -1.20835950315918, -0.0116960751920838, -34.4762450712937, -3.60468986566883, -44.1911789469279, -59.1175147807688, 5.13366103470055, 0.961369250534241, 203.625851586770, 12.2850933055170, 14.9036023305033, 0.353967297154924, -21.5295272586179, 3.43575316053561, 0.819219595702099, 1.98431079453241, -5.15394507967548, -0.961333125587442, -1.20835950317394, -0.0116960752195923, -7.08202530503630, -0.389772668121579, -34.4762450715554, -3.60468986561721, -44.1911789467406, -59.1175147812911, -5.13366103421912, -0.961369251127902, 14.9036023302647, 0.353967297126540, 203.625851581243, 12.2850932987915, -21.5295272598549, 3.43575316175927
};

/* 离地状态三维控制矩阵 */
const float Matrix_K_3d_offground[4][6] = {
    // 第一行：离地状态三维控制增益矩阵，用于机器人离地时的LQR控制器
    -3.52245568048091,-0.520508516498389,-0.968686088204664,-0.253924047818327,-5.46165227871263,-1.29563981243896,
    // 第二行：离地状态三维控制增益矩阵，用于机器人离地时的LQR控制器
    15.5635280803308,1.49961680445054,-1.46160253484416,-0.277612986749879,-11.5960781837174,-1.75616134068751,
    // 第三行：离地状态三维控制增益矩阵，用于机器人离地时的LQR控制器
    -0.968686088204659,-0.253924047818326,-3.52245568048092,-0.520508516498389,-5.46165227871261,-1.29563981243896,
    // 第四行：离地状态三维控制增益矩阵，用于机器人离地时的LQR控制器
    -1.46160253484414,-0.277612986749879,15.5635280803308,1.49961680445054,-11.5960781837174,-1.75616134068751};

